# EEVDF å…¨å±€é˜Ÿåˆ—è°ƒåº¦å™¨

åŸºäº Linux 6.12.57 sched_ext æ¡†æ¶çš„ EEVDF (Earliest Eligible Virtual Deadline First) è°ƒåº¦å™¨ï¼Œä½¿ç”¨ eBPF æŠ€æœ¯å®ç°ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. ç³»ç»Ÿè¦æ±‚

- Linux 6.12+ å†…æ ¸ï¼ˆæ”¯æŒ sched_extï¼‰
- clang/LLVM å·¥å…·é“¾
- libbpf å¼€å‘åº“

### 2. ç¼–è¯‘

```bash
make
```

ç¼–è¯‘è¾“å‡ºï¼š
- `build/eevdf.bpf.o` - eBPF å­—èŠ‚ç 
- `build/eevdf.skel.h` - ç”Ÿæˆçš„éª¨æ¶å¤´æ–‡ä»¶
- `build/loader` - ç”¨æˆ·æ€åŠ è½½å™¨

### 3. è¿è¡Œè°ƒåº¦å™¨

```bash
sudo ./build/loader
```

**åœæ­¢è°ƒåº¦å™¨**ï¼šæŒ‰ `Ctrl+C` æˆ–åœ¨å¦ä¸€ç»ˆç«¯è¿è¡Œï¼š
```bash
sudo pkill loader
```

### 4. æ£€æŸ¥çŠ¶æ€

```bash
# æŸ¥çœ‹è°ƒåº¦å™¨çŠ¶æ€
cat /sys/kernel/sched_ext/state

# æŸ¥çœ‹å†…æ ¸æ—¥å¿—
sudo dmesg | tail -20
```

---

## æµ‹è¯•è„šæœ¬

### ä¸»æµ‹è¯•è„šæœ¬

```bash
sudo ./scripts/test.sh
```

**åŠŸèƒ½**ï¼š
- å¯åŠ¨è°ƒåº¦å™¨
- ä½¿ç”¨ ftrace æ”¶é›†è°ƒåº¦äº‹ä»¶
- è¿è¡Œ CPU å‹åŠ›æµ‹è¯•
- è‡ªåŠ¨åˆ†æç»“æœ

**é€‰é¡¹**ï¼š
```bash
# ä»…è¿è¡Œ CPU æµ‹è¯•ï¼ˆæ¨èï¼‰
sudo ./scripts/test.sh --cpu-only

# è¿è¡Œæ··åˆè´Ÿè½½æµ‹è¯•ï¼ˆCPU + I/Oï¼‰
sudo ./scripts/test.sh --mixed

# è‡ªå®šä¹‰æµ‹è¯•æ—¶é•¿ï¼ˆç§’ï¼‰
sudo ./scripts/test.sh --duration 20
```

**è¾“å‡ºæ–‡ä»¶**ï¼š
- `scheduler_trace.txt` - ftrace åŸå§‹æ•°æ®
- æ§åˆ¶å°è¾“å‡ºæµ‹è¯•ç»Ÿè®¡ä¿¡æ¯

### åˆ†æè„šæœ¬

```bash
./scripts/analyze.sh scheduler_trace.txt
```

**è¾“å‡º**ï¼š
- ä¸Šä¸‹æ–‡åˆ‡æ¢ç»Ÿè®¡
- æ—¶é—´ç‰‡è½®è½¬éªŒè¯
- ä»»åŠ¡è°ƒåº¦æ¬¡æ•°
- CPU è´Ÿè½½åˆ†å¸ƒ
- è¿è¡Œæ—¶é•¿åˆ†æ

**ç¤ºä¾‹è¾“å‡º**ï¼š
```
======================================
æ—¶é—´ç‰‡è½®è½¬åˆ†æ
======================================
RçŠ¶æ€åˆ‡æ¢ï¼ˆæ—¶é—´ç‰‡ç”¨å®Œï¼‰: 22 æ¬¡
DçŠ¶æ€åˆ‡æ¢ï¼ˆI/Oç­‰å¾…ï¼‰: 56 æ¬¡
æ—¶é—´ç‰‡ç”¨å®Œçš„å æ¯”: 25.8%

âœ“ æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶å·¥ä½œæ­£å¸¸ï¼
```

### æ¸…ç†è„šæœ¬

```bash
sudo ./scripts/cleanup.sh
```

**åŠŸèƒ½**ï¼š
- å¼ºåˆ¶åœæ­¢æ‰€æœ‰ stress-ng å’Œ loader è¿›ç¨‹
- ç¦ç”¨è°ƒåº¦å™¨
- æ¸…ç† ftrace è®¾ç½®
- æ£€æŸ¥æ®‹ç•™è¿›ç¨‹

**ä½¿ç”¨åœºæ™¯**ï¼š
- æµ‹è¯•å¡ä½æ—¶ç´§æ€¥æ¸…ç†
- è°ƒåº¦å™¨å¼‚å¸¸æ—¶æ¢å¤ç³»ç»Ÿ

---

## é¡¹ç›®ç»“æ„

```
my-eevdf-scheduler/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ eevdf.bpf.c       # eBPF è°ƒåº¦å™¨æ ¸å¿ƒ
â”‚   â””â”€â”€ loader.c          # ç”¨æˆ·æ€åŠ è½½å™¨
â”œâ”€â”€ build/                # ç¼–è¯‘è¾“å‡ºï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ eevdf.bpf.o
â”‚   â”œâ”€â”€ eevdf.skel.h
â”‚   â””â”€â”€ loader
â”œâ”€â”€ scripts/              # æµ‹è¯•å’Œå·¥å…·è„šæœ¬
â”‚   â”œâ”€â”€ test.sh           # ä¸»æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ analyze.sh        # Trace åˆ†æè„šæœ¬
â”‚   â””â”€â”€ cleanup.sh        # æ¸…ç†è„šæœ¬
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ ARCHITECTURE.md   # æ¶æ„ä¸å®ç°æ–‡æ¡£
â”œâ”€â”€ README.md             # æœ¬æ–‡æ¡£
â”œâ”€â”€ Makefile              # ç¼–è¯‘é…ç½®
â””â”€â”€ .gitignore
```

---

## å¼€å‘æŒ‡å—

### ä¿®æ”¹ä»£ç 

1. ç¼–è¾‘ `src/eevdf.bpf.c` æˆ– `src/loader.c`
2. é‡æ–°ç¼–è¯‘ï¼š
   ```bash
   make clean && make
   ```
3. æµ‹è¯•ï¼š
   ```bash
   sudo ./scripts/test.sh --cpu-only
   ```

### è°ƒè¯•

**æŸ¥çœ‹ BPF æ—¥å¿—**ï¼š
```bash
sudo cat /sys/kernel/debug/tracing/trace_pipe
```

**æŸ¥çœ‹è°ƒåº¦å™¨ä¿¡æ¯**ï¼š
```bash
sudo bpftool prog list | grep sched
```

### æ€§èƒ½è°ƒä¼˜

ç¼–è¾‘ `src/eevdf.bpf.c` ä¸­çš„å‚æ•°ï¼š

```c
#define BASE_SLICE_NS   3000000ULL   // åŸºç¡€æ—¶é—´ç‰‡ï¼ˆ3msï¼‰
#define MIN_SLICE_NS    1000000ULL   // æœ€å°æ—¶é—´ç‰‡ï¼ˆ1msï¼‰
#define EEVDF_PERIOD_NS 12000000ULL  // è°ƒåº¦å‘¨æœŸï¼ˆ12msï¼‰
```

**å»ºè®®**ï¼š
- **æé«˜å“åº”æ€§**ï¼šå‡å° `BASE_SLICE_NS`ï¼ˆå¦‚ 2msï¼‰
- **å‡å°‘åˆ‡æ¢å¼€é”€**ï¼šå¢å¤§ `BASE_SLICE_NS`ï¼ˆå¦‚ 5msï¼‰
- **è°ƒæ•´å‘¨æœŸ**ï¼šä¿®æ”¹ `EEVDF_PERIOD_NS`ï¼ˆæ¨è 10-20msï¼‰

---

## å¸¸è§é—®é¢˜

### Q1: è°ƒåº¦å™¨æ— æ³•å¯åŠ¨

**æ£€æŸ¥**ï¼š
```bash
# æ£€æŸ¥å†…æ ¸æ˜¯å¦æ”¯æŒ sched_ext
cat /sys/kernel/sched_ext/state

# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯´æ˜å†…æ ¸ä¸æ”¯æŒ
```

**è§£å†³**ï¼šéœ€è¦ Linux 6.12+ å†…æ ¸å¹¶å¯ç”¨ CONFIG_SCHED_CLASS_EXT

### Q2: æµ‹è¯•å¡ä½ä¸åŠ¨

**ç´§æ€¥å¤„ç†**ï¼š
```bash
# æ–°å¼€ç»ˆç«¯
sudo ./scripts/cleanup.sh

# å¦‚æœä»å¡ä½ï¼Œå¼ºåˆ¶åœæ­¢
sudo pkill -9 loader stress-ng
```

**é¢„é˜²æªæ–½**ï¼š
- ä½¿ç”¨ `--cpu-only` æ¨¡å¼æµ‹è¯•ï¼ˆæ›´ç¨³å®šï¼‰
- é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œ

### Q3: çœ‹åˆ° "D state" è¿›ç¨‹

**è¯´æ˜**ï¼šDçŠ¶æ€ï¼ˆä¸å¯ä¸­æ–­ç¡çœ ï¼‰æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤ºè¿›ç¨‹åœ¨ç­‰å¾…I/O

**åˆ¤æ–­æ˜¯å¦å¼‚å¸¸**ï¼š
- å¦‚æœè¿›ç¨‹èƒ½ç»§ç»­è¿è¡Œ â†’ æ­£å¸¸
- å¦‚æœé•¿æ—¶é—´å¡ä½ï¼ˆ>30ç§’ï¼‰â†’ å¯èƒ½å¼‚å¸¸

**å¤„ç†**ï¼š
```bash
# æŸ¥çœ‹ D çŠ¶æ€è¿›ç¨‹
ps aux | awk '$8 ~ /D/'

# å¦‚æœæ˜¯ loader æˆ– stress-ngï¼Œè¿è¡Œæ¸…ç†è„šæœ¬
sudo ./scripts/cleanup.sh
```

### Q4: ç¼–è¯‘é”™è¯¯

**å¸¸è§é”™è¯¯**ï¼š
```
fatal error: 'bpf/bpf_helpers.h' file not found
```

**è§£å†³**ï¼šæ£€æŸ¥ Makefile ä¸­çš„å†…æ ¸æºç è·¯å¾„ï¼š
```makefile
KERNEL_SRC ?= /home/hustlhy/linux-6.12.57
```

---

## æŠ€æœ¯ç»†èŠ‚

è¯¦ç»†çš„æ¶æ„è®¾è®¡ã€ç®—æ³•åŸç†ã€æ•°æ®ç»“æ„ç­‰æŠ€æœ¯æ–‡æ¡£ï¼Œè¯·å‚é˜…ï¼š

ğŸ“– [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md)

---

## Git å·¥ä½œæµ

### æœ¬åœ°å¼€å‘

```bash
# æŸ¥çœ‹æ›´æ”¹
git status

# æäº¤æ›´æ”¹
git add .
git commit -m "æè¿°ä½ çš„æ›´æ”¹"

# æŸ¥çœ‹æäº¤å†å²
git log --oneline
```

### æ¨é€åˆ° GitHub

```bash
# æ·»åŠ è¿œç¨‹ä»“åº“ï¼ˆé¦–æ¬¡ï¼‰
git remote add origin <your-github-repo-url>

# æ¨é€
git push -u origin main
```

---

## è®¸å¯è¯

GPL v2

---

## è‡´è°¢

åŸºäº Linux å†…æ ¸çš„ sched_ext æ¡†æ¶å’Œ EEVDF è°ƒåº¦ç®—æ³•å®ç°ã€‚
